# SimLOB中存在的问题

## 1. 数据处理

### 1.1 数据生成中存在的问题

#### 1.1.1 生成ABM模型参数

在Maxe的{ref}`XML 配置文件 <XML_file>`中，除了{ref}`PGPS模型 <PGPS>`所需的6个参数之外，
还有一些（理应）可以影响模型数据生成的参数需要随机产生，以增强训练得到的神经网络的Generalization。

例如：

* `SetupAgent中`:`bidVolume`,`askVolume`,`bidPrice`,`askPrice`, 这四个参数是模型的起始状态(应该属于SimLOB模型中的上下文信息),如果在所有训练数据中都使用相同的参数作为起始值, 模型的泛用性必然遭到质疑, 特别是在面对下游任务为真实数据的情况时.
  
```{admonition} 讨论
:class: note
虽然通过数据预处理中的归一化和正则化处理后, 这些上下文信息在一定程度上能被消除, 但是ABM模型本身可能会基于这些上下文信息下订单, 特别是在比PGPS更复杂的ABM模型中.
```

* `Simulation`中: `random_seed`, 该参数决定了PGPS模型的随机性, 相同参数在不同随机种子下产生的结果可能大相径庭(还需要对Maxe中的PGPS模型进行更深入的研究才可以确定). 但如果考虑模型的随机性, 那么下游的校准任务将变得无比复杂, 这可以在后续的{ref}`Simulation-based Inference  <SBI>` 研究中做进一步讨论.

### 1.2 数据清洗时存在的问题

#### 1.2.1 错误数据
TheSimulator(或者说PGPS模型)并不保证所有生成的数据都是正确的, 即使所有参数都在指定的参数范围之内. 其中一个最典型的错误就是在LOB数据中, 价(量)产生负值, 这在实际中是不可能发生的. 在一次模拟中如果出现负值, 意味着这条数据(在SimLOB实验中为50000个时间点)后面的值都有问题.

SimLOB训练数据是由单条数据按照100时间点长度进行切分的(不重叠的滑动窗口法), 一条错误的模拟最多会向训练数据集中引入500条错误的训练数据. 以现在SimLOB训练数据集原始记录来看, 至少有 $ 66/2000=3.3% $ 条这样的数据. 从训练过程来看, 这些数据点会导致模型不稳定, 并且数量符合前面计算的`3.3%`. 如[下图](error_data)所示:

```{figure} ./imgs/error_data.png
:name: error_data

错误数据对训练造成的影响.
```

从图中可以看出, 在某些batch, 训练过程中的Loss会明显高于其他batch. 并且这些位置不因训练模型的不同而有区别. (因为在DataLoader中使用了相同的随机种子,因此这些出错的batch位置会相同.)


```{admonition} 改进方法:
:class: tip
* 在数据清洗中, 如果数据出现了错误, 就删除整条数据. 
* 记录出错的参数组合(如果后续的其他工作可能用得上).
```


#### 1.2.2 低质量数据
从上面的错误数据来看, Maxe除了生成错误数据外, 肯定还会生成不少低质量的数据, 这些数据虽然符合作为金融数据的约束条件, 但是与实际的金融数据可能相差甚远, 这样的训练数据可能会影响模型的校准能力.

```{admonition} 讨论
:class: note

有几点可以再仔细研究:
1. 如何判断不良数据? (Stylized Factors?)
2. 这些数据与金融市场的异常数据有什么区别和联系? 
    * 是否可以利用这些数据训练模型, 让模型可以检测异常?
```

### 1.3 数据预处理时存在的问题
#### 1.3.1 训练数据分割
现在的训练集是通过分割Maxe产生的原始LOB数据产生, 分割方法是非重叠的滑动窗口法, 将原始时间步为50000的时序数据按100每段进行切分, 每条原始数据获得500条训练数据.
```{admonition} 冷启动问题
:class: warning

从前面对Maxe模拟器的xml文件的了解可以知道, 每一次模拟产生数据时都有一个上下文状态, 在SimLOB中, 该状态为:
    * bidVolume="10"
    * askVolume="10"
    * bidPrice="7514.9"
    * askPrice="7516.1"

一个直观的分析就是,这个LOB状态非常单薄, 如果在启动时产生一个超过10手的市价买单, 卖方就会被买空, 可能导致下一次卖单没有参考价格(系统认为目前最佳卖价为正无穷); 反之, 如果起始时产生超过10手的市价卖单, 买房会被买空, 导致下次买单没有参考价格(系统认为目前最佳买家为0). 

```


```{admonition} 解决方案
:class: tip

一个可行的方案是, 抛开原始数据的起始部分(比如前2000个时间步), 对剩下的部分进行采样.

采样的方案也可以不局限于非重叠的滑动窗口法, 可能以某个百分比重叠的滑动窗口更能抓住时序数据中的自相关属性.

```

### 1.4 其他细节问题

#### 1.4.1 生成的效率

**问题所在:**

在使用Maxe编译得到的`TheSimulator`仿真器生成数据时, 有两个重要步骤:

    1. 产生{ref}`XML 配置文件 <XML_file>`
    2. 通过`TheSimulator`读取该文件, 进行模拟后将输出保存在`.csv`文件中

这两个步骤都需要对磁盘进行读写, 在大量生成数据时会产生两个问题:

```{admonition} 问题:
:class: warning

1. 读写效率: 对物理磁盘进行读写, I/O的效率相比内存读写要低很多, 特别是当Maxe采用多进程/线程的方式模拟多个Agent时

2. 在数据生成过程中循环使用相同的文件名保存xml配置文件, 单进程时不会影响, 如果多进程同时更新/读取同一个配置文件时会导致出错/重复. 
```

```{admonition} 解决办法:
:class: tip

使用python提供的虚拟文件系统包:`tempFiles`

  * 在内存中模拟文件句柄并返回给生成xml文件进程, 将xml配置写入虚拟文件, 同时在xml文件的输出配置项中写入另一个虚拟文件句柄.
  * 通过TheSimulator进行仿真, 数据会被写入上述虚拟文件中.
  * 这样做的好处有:
    * 虚拟文件名会自动进行hash不会出现相同文件名的情况.
    * 虚拟文件在内存中读写速度更快.
    * 可以直接将模拟结果读入pandas的DataFrame不进行中转.
    * 内存数据会按照系统资源使用情况被自动清理(也可以手动清理.)
```




## 2. 方法详情

## 3. 实验设置

## 4. 代码实现

## 5. ABM模型
